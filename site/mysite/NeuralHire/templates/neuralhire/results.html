{% extends 'neuralhire/base.html' %}

{% block content %}
{% load job_filters %}

<!-- Error Message -->
{% if error %}
<div
    style="margin: 30px 50px; padding: 20px; background-color: #f5f5f5; border-left: 4px solid #333; border-radius: 5px;">
    <strong style="color: #333;">Ошибка:</strong> {{error}}
</div>
{% endif %}

<div class="result" style="margin: 30px 50px;">
    {% if user_query %}
    <h2 style="color: #000; margin-bottom: 20px;">
        Результаты поиска: <span style="font-weight: normal;">{{ user_query }}</span>
    </h2>
    {% elif resume_summary %}
    <h2 style="color: #000; margin-bottom: 20px;">
        Найденные вакансии
    </h2>
    {% endif %}
</div>

<div class="container" style="margin: 0 50px;">

    {% for job in jobs %}
    <div class="card"
        style="margin-bottom: 30px; padding: 25px; background-color: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #000;">
        <div class="card-body">
            <!-- Job Title -->
            <h3 style="color: #000; margin-bottom: 15px; font-size: 22px; font-weight: bold;">{{ job.title }}</h3>

            <!-- Company, Rating and City -->
            <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                {% if job.company and job.company != 'Unknown' and job.company != 'nan' %}
                <div style="display: flex; align-items: center; gap: 8px;">
                    <strong>Компания:</strong>
                    <span class="js-company-name">{{ job.company }}</span>
                </div>
                {% endif %}
                {% if job.city and job.city != 'Unknown' and job.city != 'nan' %}
                <div style="display: flex; align-items: center; gap: 8px;">
                    <strong>Город:</strong>
                    <span>{{ job.city }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Salary -->
            {% if job.money and job.money != -1 and job.money > 0 %}
            <p style="margin-bottom: 15px; font-size: 18px;">
                <strong>Зарплата:</strong> <span class="js-money-value" style="color: #000; font-weight: bold;">{{
                    job.money }}</span> <span style="color: #000; font-weight: bold;">000 рублей</span>
            </p>
            {% elif job.money == -1 %}
            <p style="margin-bottom: 15px; font-size: 18px;">
                <strong>Зарплата:</strong> <span style="color: #000; font-weight: bold;">По договорённости</span>
            </p>
            {% endif %}

            <!-- AI Explanation for top 3 jobs -->
            {% if job.explanation %} <div
                style="margin: 15px 0; padding: 15px; background-color: #f5f5f5; border-left: 4px solid #333; border-radius: 5px;">
                <div style="margin-bottom: 8px;">
                    <strong style="color: #000;">Почему эта вакансия подходит:</strong>
                </div>
                <p style="margin: 0; line-height: 1.6; color: #333;">{{ job.explanation }}</p>

                <!-- Resume Evidence Crop -->
                {% with crop_path=job_crops|get_item:job.id %}
                {% if crop_path %}
                <div style="margin-top: 10px;">
                    <button onclick="toggleCrop('crop-{{ job.id }}')"
                        style="background: none; border: none; color: #666; cursor: pointer; text-decoration: underline; padding: 0; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                        <span>Показать подтверждение из резюме</span>
                    </button>
                    <div id="crop-{{ job.id }}" style="display: none; margin-top: 10px;">
                        <img src="/media/{{ crop_path }}" alt="Resume evidence"
                            style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    </div>
                </div>
                {% endif %}
                {% endwith %}
            </div>
            {% endif %}

            <!-- Requirements Preview -->
            {% if job.knoladge and job.knoladge != 'nan' and job.knoladge|length > 0 %}
            <div style="margin: 15px 0;">
                <strong>Требования:</strong>
                <p style="margin: 5px 0; color: #666; line-height: 1.5;">{{ job.knoladge|truncatewords:30 }}</p>
            </div>
            {% endif %}

            <!-- Additions -->
            {% if job.addition and job.addition != '[]' and job.addition != 'nan' %}
            <div style="margin: 15px 0;">
                <strong>Дополнительно:</strong>
                <ul class="addition-list" style="margin: 5px 0; padding-left: 20px;">
                    {% for item in job.addition|split_by_comma %} <li style="color: #666;">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Link -->
            {% with corrected_link=job.link|get_link %}
            <a href="{{ corrected_link }}" class="card-link"
                style="display: inline-block; margin-top: 15px; padding: 10px 20px; background-color: white; color: #000; text-decoration: none; border: 2px solid #000; transition: all 0.3s;">
                Перейти к вакансии
            </a>
            {% endwith %}
        </div>
    </div>

    {% endfor %}
</div>

<script>
    // Format salary numbers and extract ratings
    document.addEventListener('DOMContentLoaded', (event) => {
        // Format salaries
        const moneyElements = document.querySelectorAll('.js-money-value');
        const formatter = new Intl.NumberFormat('ru-RU');

        moneyElements.forEach(element => {
            const rawValue = element.textContent.trim();
            const numericValue = parseInt(rawValue, 10);

            if (!isNaN(numericValue) && numericValue > 0) {
                element.textContent = formatter.format(numericValue);
            }
        });

        // Extract and display ratings from company names
        const companyElements = document.querySelectorAll('.js-company-name');
        companyElements.forEach(element => {
            const text = element.textContent.trim();
            const ratingMatch = text.match(/(\d+\.\d+)\s*$/);

            if (ratingMatch) {
                const rating = ratingMatch[1];
                const companyName = text.replace(ratingMatch[0], '').replace('Проверенный работодатель', '').trim();

                // Update the company name without rating
                element.textContent = companyName;

                // Add rating badge after company name
                const ratingBadge = document.createElement('span');
                ratingBadge.style.cssText = 'margin-left: 8px; padding: 2px 8px; background-color: #f0f0f0; border-radius: 4px; font-size: 14px; color: #666;';
                ratingBadge.textContent = '★ ' + rating;
                element.parentNode.appendChild(ratingBadge);
            }
        });
    });

    function toggleCrop(id) {
        var x = document.getElementById(id);
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
</script>

<div class="footer" style="margin: 30px 50px; padding: 20px 0; border-top: 2px solid #eee; color: #666;">
    <p>Сайт сделан Нарынбаевым Нурсултаном.</p>
    <p>Вакансии взяты: russia.superjob.ru</p>
</div>

<style>
    a {
        color: #000;
    }

    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
    }

    .card-link:hover {
        animation: buttonPulse 1s ease-in-out infinite;
    }

    @keyframes buttonPulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.3);
        }

        50% {
            box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
        }
    }
</style>
{% endblock %}